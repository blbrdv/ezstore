name: Remove old Pull Requests cache

on:
  workflow_dispatch:
  push:
    branches:
      - "main"

jobs:
  clear:
    name: Remove old Pull Requests cache

    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - name: List
        run: |
          closed_prs=$(gh pr list --state closed --json number,title)

          while IFS= read -r pr; do
            pr_id=$(echo "$pr" | jq -r '.number')
            pr_title=$(echo "$pr" | jq -r '.title')
            echo "Pr $pr_id '$pr_title'"

            pr_caches=$(gh cache list --ref "refs/pull/$pr_id/merge" --json id,key,ref)
            echo "$pr_caches"
          done <<< "$(echo "$closed_prs" | jq -c '.[]')"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: Release

on:
  push:
    tags:
      - "*"

jobs:
  release:
    runs-on: windows-latest

    name: Build and release project

    steps:
    - uses: actions/checkout@v4

    - id: iscc-path
      run: |
        $Path = "${env:TEMP}\inno"
        echo "path=$Path" >> $ENV:GITHUB_OUTPUT
        echo $ENV:GITHUB_OUTPUT

    - name: Restore cache
      uses: actions/cache/restore@v4
      with:
        path: |
          ~\go
          ~\AppData\Local\go-build
          ${{ steps.iscc-path.outputs.path }}
        key: cache-go-release-${{ hashFiles( './go.mod', './go.sum' ) }}

    - name: Setup GO
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'
        cache: false

    - name: Download project dependencies
      run: go get .\...

    - name: Setup go-winres@latest
      run: |
        go install "github.com/tc-hib/go-winres@latest"

    - id: iscc-check
      run: |
        $Test = ${{ steps.iscc-path.outputs.path }} | Test-Path
        $Result = ([string]$Test).ToLower()
        echo "is-installed=$Result" >> $ENV:GITHUB_OUTPUT
        echo $ENV:GITHUB_OUTPUT

    - uses: pwall2222/inno-setup-download@v0.0.8
      if: ${{ steps.iscc-check.outputs.is-installed != 'true' }}

    - name: Build project
      run: .\run.ps1 build

    - name: Release project
      uses: anton-yurchenko/git-release@v6
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        args: release/*

    - name: Restore cache
      uses: actions/cache/save@v4
      with:
        path: |
          ~\go
          ~\AppData\Local\go-build
        key: cache-go-release-${{ hashFiles( './go.mod', './go.sum' ) }}

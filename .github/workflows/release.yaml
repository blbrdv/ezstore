name: Release

on:
  push:
    tags:
      - "*"

jobs:
  release:
    runs-on: windows-latest

    name: Build and release project

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'

    - name: Setup go-winres@0.3.3
      uses: mattdowdell/go-installer@v0.3.0
      with:
        package: github.com/tc-hib/go-winres
        version: 0.3.3

    - name: Restore Inno Setup cache
      uses: actions/cache/restore@v4
      id: cache-iscc
      with:
        path: .\inno
        key: cache-iscc-${{ hashFiles( '.\inno\**' ) }}

    - uses: pwall2222/inno-setup-download@v0.0.8
      if: ${{ steps.cache-iscc.outputs.cache-hit != 'true' }}

    - name: Save Inno Setup cache
      if: ${{ steps.cache-iscc.outputs.cache-hit != 'true' }}
      uses: actions/cache/save@v4
      with:
        path: .\inno
        key: cache-iscc-${{ hashFiles( '.\inno\**' ) }}

    - name: Build project
      run: .\run.ps1 build

    - name: Release project
      uses: anton-yurchenko/git-release@v6
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        args: release/*
